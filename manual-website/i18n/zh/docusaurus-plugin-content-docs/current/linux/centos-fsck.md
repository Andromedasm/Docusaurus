---
id: azure-fsck
title: Azure VM fsck問題
---

# Azure VMのファイルシステムチェック問題に関する対処マニュアル

## 問題の説明
Azure上のCentOS仮想マシンが起動した後、SSH接続できず、ウェブサイトにもアクセスできない問題が発生しました。Serial Consoleでログインすると、システムがファイルシステムチェック（fsck）の段階で停止していることが判明しました。以下はログの一部です：

```
ファイルシステムを検査中

すべてのファイルシステム検査します。

[/sbin/fsck.ext4 (1) -- /] fsck.ext4 -a /dev/sda1

/dev/sda1: clean, 216594/1966080 files, 3548024/7864064 blocks

[/sbin/fsck.ext4 (1) -- /data] fsck.ext4 -a /dev/md127

/dev/md127 has gone 2441 days without being checked, check forced.

hv_balloon: Received INFO_TYPE_MAX_PAGE_CNT
hv_balloon: Data Size is 8
```

## 考えられる原因
システムが長期間ファイルシステムチェックを行っていなかったため、起動時に強制的に`fsck`が実行され、システムの起動が遅延し、SSH接続やウェブサイトサービスに影響を与えています。

## 解決方法

### 1. ファイルシステムチェックの完了を待つ
ファイルシステムチェックが進行中の場合、最も簡単な解決策は、チェックが完了するのを待つことです。`fsck`は自動的にファイルシステムのエラーを修正し、完了後にシステムは通常の起動を再開します。

チェックにかかる時間は、ディスクのサイズやファイルの数によって異なり、数分から数十分かかる場合があります。急がない場合は、チェックの完了を待つことをお勧めします。

### 2. ファイルシステムチェックをスキップする

ファイルシステムチェックをスキップする必要がある場合は、シングルユーザーモードまたは緊急モードでシステムを起動し、チェックをスキップすることができます。

#### 方法：
1. Azure Portalから仮想マシンの**Serial Console**にアクセスします。
2. システムの起動メニューが表示されたら、起動カーネルのオプションを選択し、`e`キーを押して編集モードに入ります。
3. `linux16`で始まる行を見つけ、その行の末尾に次の内容を追加します：
   ```
fsck.mode=skip
   ```
4. `Ctrl + X`を押して、起動を続行します。

これにより、ファイルシステムチェックをスキップし、すぐにシステムにアクセスできるようになります。

### 3. ファイルシステムチェックを永久に無効化する

システム起動時に自動でファイルシステムチェックが行われないようにする場合は、永久に無効化することもできます。ただし、これにはリスクが伴います。ファイルシステムチェックを無効にすると、潜在的なディスクエラーが自動的に修正されなくなるため、定期的に手動でチェックを行うことをお勧めします。

#### 方法：
1. システムにログインした後、`tune2fs`コマンドを使用してファイルシステムのチェック頻度を調整します。

   - 現在の設定を確認する：
     ```bash
     sudo tune2fs -l /dev/sda1 | grep 'Mount count'
     sudo tune2fs -l /dev/md127 | grep 'Mount count'
     ```

   - 自動チェックを無効にする（例として`/dev/sda1`と`/dev/md127`）：
     ```bash
     sudo tune2fs -c 0 -i 0 /dev/sda1
     sudo tune2fs -c 0 -i 0 /dev/md127
     ```

     ここで、`-c 0`はマウント回数に基づくチェックを無効化し、`-i 0`は時間間隔に基づくチェックを無効化します。

2. **`/etc/fstab`ファイルを更新**して、ファイルシステムが自動的にチェックされないようにします。

   - `/etc/fstab`ファイルを編集：
     ```bash
     sudo vi /etc/fstab
     ```

   - マウントされているファイルシステムの最後の列（通常は`1`または`2`）を`0`に変更し、チェックを無効にします。例：

     ```
     UUID=xxxxxx-xxxx-xxxx-xxxx-xxxxxxxxx / ext4 defaults 0 0
     UUID=yyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyy /data ext4 defaults 0 0
     ```

3. **システムを再起動**して変更を適用します：

   ```bash
   sudo reboot
   ```

### 4. ファイルシステムの手動チェック

自動ファイルシステムチェックを無効化した場合でも、定期的に手動でファイルシステムをチェックして、システムが正常であることを確認する必要があります：

```bash
sudo fsck /dev/sda1
sudo fsck /dev/md127
```

手動でチェックする前に、対象のパーティションがマウントされていないことを確認します。マウントされている場合は、システムのリカバリモードでチェックするか、以下のコマンドで読み取り専用でマウントします：

```bash
sudo mount -o remount,ro /dev/sda1
sudo fsck /dev/sda1
```

## まとめ
- **チェック完了を待つ**：最も簡単な解決策は、ファイルシステムチェックが完了するまで待つことです。
- **チェックをスキップ**：`fsck.mode=skip`を使用して、ファイルシステムチェックをスキップし、起動プロセスを早めます。
- **チェックを無効化**：`tune2fs`と`/etc/fstab`を使用して、自動チェックを無効にしますが、手動で定期的にファイルシステムのチェックを行うことをお勧めします。

## よく使うコマンド一覧

| コマンド | 説明 |
| --- | --- |
| `fsck -y /dev/sda1` | ルートファイルシステムの手動修復 |
| `sudo tune2fs -c 0 -i 0 /dev/sda1` | ルートファイルシステムの自動チェックを無効化 |
| `sudo systemctl restart sshd` | SSHサービスの再起動 |
| `sudo systemctl restart httpd` | Apacheウェブサービスの再起動 |
| `sudo systemctl restart nginx` | Nginxウェブサービスの再起動 |
| `fsck.mode=skip` | ファイルシステムチェックをスキップ（起動時にカーネルパラメータに追加） |
