---
id: ssh-guide
title: SSHマニュアル
---

# SSH 使用マニュアル

このガイドでは、SSH（Secure Shell）の基本的な使い方から応用的なテクニックまでを詳細に説明します。SSHは、ネットワーク経由でリモートコンピュータに安全に接続し、コマンドラインインターフェースを操作するためのプロトコルです。サーバー管理やリモートアクセスなどで広く使用されています。

## 目次
1. [SSHのインストール](#sshのインストール)
2. [基本的な使用方法](#基本的な使用方法)
   - [SSHの起動](#sshの起動)
   - [リモートホストへの接続](#リモートホストへの接続)
   - [鍵認証の設定](#鍵認証の設定)
3. [SSHの応用](#sshの応用)
   - [ポートフォワーディング](#ポートフォワーディング)
   - [ファイル転送](#ファイル転送)
   - [SSHエージェントの使用](#sshエージェントの使用)
   - [プロキシを介した接続](#プロキシを介した接続)
4. [セキュリティに関する注意点](#セキュリティに関する注意点)
5. [トラブルシューティング](#トラブルシューティング)

## SSHのインストール

SSHは、多くのオペレーティングシステムで利用可能ですが、デフォルトでインストールされていない場合があります。以下の手順でインストールを行います。

### Windowsの場合

Windows 10以降では、OpenSSHクライアントがデフォルトで含まれています。含まれていない場合は、以下の手順でインストールできます。

1. **設定**を開きます。
2. **アプリ**を選択します。
3. **オプション機能**をクリックします。
4. **機能の追加**をクリックし、**OpenSSH Client**を選択してインストールします。

### macOSの場合

macOSでは、SSHクライアントはデフォルトでインストールされています。追加のインストールは必要ありません。

### Linuxの場合

多くのLinuxディストリビューションでは、SSHクライアントはデフォルトでインストールされていますが、インストールされていない場合は、パッケージマネージャを使用してインストールできます。例えば、Ubuntuでは以下のコマンドを使用します。

```bash
sudo apt-get install openssh-client
```

## 基本的な使用方法

### SSHの起動

ターミナル（またはコマンドプロンプト）を開き、`ssh`コマンドを入力して起動します。

```bash
ssh
```

### リモートホストへの接続

リモートホストに接続するには、`ssh`コマンドにユーザー名とホスト名またはIPアドレスを指定します。例えば、ユーザー名が`user`でホストが`example.com`の場合、以下のように入力します。

```bash
ssh user@example.com
```

### デフォルトのポートを変更する場合

SSHはデフォルトでポート22を使用しますが、異なるポートを使用する場合は-pオプションを追加します。

```bash
ssh user@example.com -p 2222
```

### 鍵認証の設定

SSHの鍵認証を設定することで、パスワードを入力せずにリモートホストに接続できます。

#### 鍵ペアの生成

まず、SSH鍵ペアを生成します。

```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

指示に従って、鍵ペアを保存します。デフォルトの保存場所は`~/.ssh`ディレクトリです。

#### 公開鍵のコピー

生成された公開鍵をリモートホストにコピーします。

```bash
ssh-copy-id user@example.com
```

### 手動で公開鍵をコピーする場合


以下のコマンドを使って手動で公開鍵をリモートホストにコピーできます。

```bash
cat ~/.ssh/id_rsa.pub | ssh user@example.com 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys'
```

これで、次回からはパスワードを入力せずに接続できるようになります。

## SSHの応用

### ポートフォワーディング

SSHを使用して、ローカルポートとリモートポートをフォワーディングすることができます。例えば、ローカルの8080番ポートをリモートの80番ポートにフォワーディングするには、以下のようにします。

```bash
ssh -L 8080:localhost:80 user@example.com
```

### リバースポートフォワーディング

リバースポートフォワーディングを使用して、リモートポートをローカルポートにフォワーディングすることもできます。

```bash
ssh -R 8080:localhost:80 user@example.com
```

### ファイル転送

SCP（Secure Copy）を使用して、ファイルを安全に転送できます。

#### ファイルのアップロード

ローカルファイルをリモートホストにアップロードするには、以下のコマンドを使用します。

```bash
scp localfile.txt user@example.com:/remote/directory/
```

#### ファイルのダウンロード

リモートファイルをローカルにダウンロードするには、以下のコマンドを使用します。

```bash
scp user@example.com:/remote/file.txt /local/directory/
```

### ディレクトリの転送

ディレクトリを再帰的に転送する場合は、-rオプションを使用します。

```bash
scp -r localdir user@example.com:/remote/directory/
```

## SSHエージェントの使用

SSHエージェントを使用すると、パスフレーズを一度入力するだけで、複数のSSH接続で同じ鍵を使用できます。

### エージェントの起動と鍵の追加

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa
```

## プロキシを介した接続

プロキシを介してSSH接続を行うには、ProxyJumpまたはProxyCommandオプションを使用します。

### ProxyJumpを使用する場合

```bash
ssh -J proxyuser@proxyhost:port user@destinationhost
```

### ProxyCommandを使用する場合

```bash
ssh -o ProxyCommand="ssh proxyuser@proxyhost -W %h:%p" user@destinationhost
```

## セキュリティに関する注意点

SSHは非常に安全なプロトコルですが、以下の点に注意して使用してください。

1. **強力なパスワード**を使用し、可能であれば鍵認証を使用します。
2. **ファイアウォール**でSSHアクセスを制限し、必要なホストのみからの接続を許可します。
3. **ポート番号の変更**を検討し、デフォルトの22番ポート以外を使用します。
4. **ログイン試行の制限**を設定し、ブルートフォース攻撃を防止します。
5. **SSH設定ファイルの最適化**、例えばPermitRootLoginをnoに設定し、ルートユーザーの直接ログインを禁止します。
6.  **Fail2banの導入**、SSHへの不正アクセスを防ぐために、Fail2banなどのツールを使用します。

## トラブルシューティング

### 接続できない場合

1. **ネットワーク接続**を確認します。リモートホストに到達できるかどうかを確認します。
2. **ファイアウォールの設定**を確認します。SSHの通信がブロックされていないか確認します。
3. **ホスト名とポート番号**が正しいことを確認します。タイプミスがないか確認します。
4. **リモートホストのSSHサービス**が起動していることを確認します。

### 認証に失敗する場合

1. **ユーザー名とパスワード**が正しいことを確認します。
2. **公開鍵認証**を使用している場合、公開鍵が正しくコピーされているか確認します。
3. **リモートホストのSSH設定**を確認し、鍵認証が有効になっているか確認します。
4. **パーミッションの設定**、~/.sshディレクトリとその中のファイルのパーミッションが正しいことを確認します。~/.sshは700、authorized_keysは600に設定する必要があります。

```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

### よくあるエラーメッセージと対処法
1. **"Permission denied (publickey)"**: 公開鍵が正しく設定されていない可能性があります。公開鍵がリモートホストの~/.ssh/authorized_keysに正しくコピーされていることを確認します。
2. **"Connection refused"**: リモートホストでSSHサービスが実行されていないか、ファイアウォールでブロックされている可能性があります。
3. **"Host key verification failed"**: サーバーのホスト鍵が変更された場合に表示されます。~/.ssh/known_hostsファイルから該当するエントリを削除し、再度接続します。

以上で、SSHの基本的な使用方法とトラブルシューティングの説明を終わります。SSHは強力で柔軟なツールですが、セキュリティに注意しながら使用してください。
