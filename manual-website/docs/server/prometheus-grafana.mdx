---
id: prometheus-grafana
title: Prometheus
---

# サーバー管理(Prometheus+Grafana)

---

# 目次

## 1. 概要

#### 1.1. Prometheusの紹介

> #### I. 概要#### II. 機能#### III. 特徴

#### 1.2. Grafanaの紹介

> ##### I. 概要##### II. 機能##### III. 特徴

##

## 2. 環境の準備

#### 2.1. ハードウェアとソフトウェアの要求

#### 2.2. 参考アーキテクチャ

## 3. Prometheusのインストールと設定

#### 3.1. インストール方法

> ##### I. ソースコードからのインストール##### II. 事前コンパイル済みパッケージの使用##### III. コンテナの使用

#### 3.2. 設定方法

> ##### I. 設定ファイルの構造##### II. scarpe targetsの定義方法##### III. alertingの設定

#### 3.3. 起動と確認

## 4. Grafanaのインストールと設定

#### 4.1. インストール方法

#### 4.2. データソースの設定

#### 4.3. 初回ログインとインタフェースの紹介

## 5. PrometheusとGrafanaの使用

#### 5.1. Prometheusのクエリ

#### 5.2. Grafanaダッシュボードの設定

#### 5.3. Alertingと通知

## 6. よくある質問と解決策

#### 6.1. データが表示されない

#### 6.2. クエリエラー

#### 6.3. 通知が送信できない

#### 6.4. その他

## 7. 上級者向け

#### 7.1. クラスタリングのデプロイ

#### 7.2. 高可用性

#### 7.3. 他のツールとの統合

---

# I. PrometheusとGrafanaの紹介

## 1. Prometheusとは？

Prometheusは、オープンソースのモニタリングとアラートシステムです。2012年にSoundCloudによって作成され、2016年にCloud Native Computing Foundationのプロジェクトとして採用されました。

### 特徴:

- **多次元データモデル**: 時系列データは、メトリクス名とキーバリューペアのセットによって識別されます。
- **強力なクエリ言語**: PromQLを使用して、多次元データを効果的にクエリできます。
- **自己発見**: ターゲットを自動的に発見してスクレイピングできる。
- **軽量**: Goで書かれており、シングルバイナリでデプロイできます。
- **高可用性と連携**: 他のPrometheusサーバーと連携して、高可用性を持たせることができます。

## 2. Grafanaとは？

Grafanaは、オープンソースのダッシュボードとアラートプラットフォームであり、多くのデータソースからのメトリクスを可視化するための最も人気のあるツールの1つです。

### 特徴:

- **柔軟な可視化**: グラフ、ヒートマップ、シングルスタットなどの多くの可視化オプションがあります。
- **多数のデータソース**: GrafanaはPrometheusだけでなく、多くのデータソースをサポートしています。
- **アラート**: アラートルールを簡単に設定して、外部システムに通知できます。
- **カスタマイズ可能**: プラグインを利用して、ダッシュボードやデータソースをカスタマイズできます。

## 3. PrometheusとGrafanaの連携

PrometheusとGrafanaを連携させると、Prometheusから収集されるメトリクスを、Grafanaのダッシュボードで美しく可視化することができます。

### ステップ:

1. **GrafanaにPrometheusをデータソースとして追加**: Grafana UIで「データソースを追加」を選択し、Prometheusを選びます。
2. **URLを設定**: PrometheusサーバーのURLを入力します。
3. **保存&テスト**: 設定を保存し、接続をテストします。
4. **ダッシュボードの作成**: 新しいダッシュボードを作成し、Prometheusからのクエリを使用して、必要な情報を表示します。

## まとめ

PrometheusとGrafanaは、モダンな監視と可視化のための強力な組み合わせを提供します。これにより、システムのヘルスやパフォーマンスの問題を迅速に特定し、対応することができます。

# II. PrometheusとZabbixの比較

PrometheusとZabbixは、オープンソースの監視ツールとして知られています。両者ともに多くの機能を提供しますが、使用方法、アーキテクチャ、目的には顕著な違いがあります。以下に、それぞれの特徴、メリット、デメリットを詳細にまとめました。

## Prometheus

### 特徴

- **Pullベースの監視:** Prometheusは、事前に定義した間隔でターゲットから情報を"pull"（取得）します。
- **Time-Series Database:** メトリクスは時系列データベースに保存されます。
- **PromQL:** 効果的なデータのクエリと視覚化のための専用のクエリ言語。
- **多くの統合:** `exporters`として知られる、多くのアプリケーションやサービスに対する統合が利用可能。

### メリット

1. **高い柔軟性:** PromQLを使用することで、非常に詳細なクエリやアラートを作成できます。
2. **拡張性:** 複数の`exporters`や統合により、多くのシステムやサービスを監視できます。
3. **クラウドネイティブ対応:** Kubernetesなどのクラウドネイティブテクノロジーとの統合が豊富。

### デメリット

1. **学習曲線:** PromQLや設定は、初心者には少々難易度が高い場合があります。
2. **長期保存:** 大量のメトリクスデータの長期保存には追加のツール（例：Thanos, Cortex）が必要。

## Zabbix

### 特徴

- **Push/Pull両方の監視:** Zabbix Agentを使って情報を"push"するか、SNMPやJMXを使用して"pull"します。
- **RDBMSストレージ:** PostgreSQL, MySQL, Oracleなどの関係データベースをバックエンドとして使用。
- **統合ダッシュボード:** 一元的なダッシュボードでの監視、アラート、視覚化。

### メリット

1. **多機能:** オールインワンのソリューションとして、多くの機能やプラグインを提供。
2. **成熟したソリューション:** 長い歴史を持ち、安定しています。
3. **広範なドキュメント:** 豊富なドキュメントやコミュニティサポート。

### デメリット

1. **複雑性:** 多機能であるため、設定やトラブルシューティングが複雑になることがあります。
2. **UIの古さ:** UIは機能的ですが、デザインが少々古いと感じる場合があります。
3. **スケーラビリティ:** 大規模な環境でのスケーラビリティに関する懸念が挙げられることがあります。

## まとめ

PrometheusとZabbixは、それぞれ異なるアプローチと特長を持つ監視ツールです。最終的な選択は、監視したい環境、必要な機能、そしてチームのスキルセットに依存します。

# III. RHELにPrometheusをインストールする手順

Prometheusは、オープンソースの監視ツールで、システムのモニタリングとアラートを行うために広く使用されています。このマニュアルでは、RHEL(Red Hat Enterprise Linux)にPrometheusをインストールし、基本的な設定を行う手順を詳細に説明します。

## 前提条件

- RHELがインストールされ、インターネット接続が確立されていること
- `root`または`sudo`権限を持つユーザーアクセス

## 1. 必要なツールのインストール

まず、必要なパッケージをインストールします。

```bash
sudo dnf install -y wget tar
```

## 2. Prometheusのダウンロードとインストール

1. **Prometheusの公式サイトから最新バージョンをダウンロードします。**

```bash
cd /tmp
wget https://github.com/prometheus/prometheus/releases/download/vX.X.X/prometheus-X.X.X.linux-amd64.tar.gz
```

`X.X.X`はダウンロードしたいPrometheusのバージョンに置き換えてください。

詳細情報はPrometheusの公式Github Repositoryに参考してください。

2. **アーカイブを解凍し、必要なファイルを`/usr/local/bin`にコピーします。**

```bash
tar xvzf prometheus-X.X.X.linux-amd64.tar.gz
sudo mv prometheus-X.X.X.linux-amd64/prometheus /usr/local/bin/
sudo mv prometheus-X.X.X.linux-amd64/promtool /usr/local/bin/
```

3. **設定ファイルとデータディレクトリを作成します。**

```bash
sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus
sudo mv prometheus-X.X.X.linux-amd64/prometheus.yml /etc/prometheus/
```

## 3. Prometheusをサービスとして実行

1. **Systemdサービスファイルを作成します。**

```bash
sudo vim /etc/systemd/system/prometheus.service
```

以下の内容を追加します。

```
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=prometheus
Restart=always
RestartSec=5
ExecStart=/usr/local/bin/prometheus \
  --config.file /etc/prometheus/prometheus.yml \
  --storage.tsdb.path /var/lib/prometheus/ \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries

[Install]
WantedBy=multi-user.target
```

2. **Prometheusユーザーを作成し、所有権を設定します。**

```bash
sudo useradd --no-create-home --shell /bin/false prometheus
sudo chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

3. **サービスをリロードし、Prometheusを起動します。**

```bash
sudo systemctl daemon-reload
sudo systemctl start prometheus
sudo systemctl enable prometheus
```

4. **Prometheusが正常に動作していることを確認します。**

Webブラウザを開き、`http://your_server_ip:9090/`にアクセスしてPrometheusのUIが表示されることを確認します。

## 4. 基本設定

1. **設定ファイルを編集します。**

```bash
sudo vim /etc/prometheus/prometheus.yml
```

このファイルを編集して、必要に応じて監視ターゲットやルールを追加/変更します。

2. **変更を反映させるためにPrometheusを再起動します。**

```bash
sudo systemctl restart prometheus
```

## まとめ

このマニュアルを使用して、RHELにPrometheusを正常にインストールおよび設定できるはずです。更なる設定や詳細なオプションは、公式ドキュメントを参照してください。

# IV. サーバーの死活監視をPrometheusで実施する手順

Prometheusを使用して、サーバーの死活監視（アップ/ダウンのステータス確認）を行う方法を説明します。

## 前提条件

- Prometheusが既にインストールされていること
- `root`または`sudo`権限を持つユーザーアクセス

## 1. `blackbox_exporter`のインストール

サーバーの死活監視のためには、`blackbox_exporter`というツールを使用します。これをインストールして設定します。

1. **`blackbox_exporter`をダウンロードします。**

```bash
cd /tmp
wget https://github.com/prometheus/blackbox_exporter/releases/download/vX.X.X/blackbox_exporter-X.X.X.linux-amd64.tar.gz
```

`X.X.X`はダウンロードしたいバージョンに置き換えてください。

2. **アーカイブを解凍し、バイナリを適切なディレクトリに移動します。**

```bash
tar xvzf blackbox_exporter-X.X.X.linux-amd64.tar.gz
sudo mv blackbox_exporter-X.X.X.linux-amd64/blackbox_exporter /usr/local/bin/
```

3. **設定ファイルとディレクトリを作成します。**

```bash
sudo mv blackbox_exporter-X.X.X.linux-amd64/blackbox.yml /etc/prometheus/
```

## 2. `blackbox_exporter`の設定

1. **設定ファイルを編集します。**

```bash
sudo vim /etc/prometheus/blackbox.yml
```

このファイルには、様々なプローブのタイプ（HTTP, TCP, ICMPなど）に関する設定が含まれています。デフォルト設定は大抵の場合で十分ですが、必要に応じて調整を行ってください。

2. **`blackbox_exporter`をサービスとして実行します。**

Systemdサービスファイルを作成します。

```bash
sudo vim /etc/systemd/system/blackbox_exporter.service
```

以下の内容を追加します。

```
[Unit]
Description=Blackbox Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=nobody
ExecStart=/usr/local/bin/blackbox_exporter --config.file /etc/prometheus/blackbox.yml

[Install]
WantedBy=multi-user.target`
```

サービスをリロードし、`blackbox_exporter`を起動します。

```bash
sudo systemctl daemon-reload
sudo systemctl start blackbox_exporter
sudo systemctl enable blackbox_exporter
```

## 3. Prometheusの設定

1. **Prometheusの設定ファイルを編集します。**

```bash
sudo vim /etc/prometheus/prometheus.yml
```

以下の内容を追加します。

```yaml
scrape_configs:
  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx] # ここは監視方法に応じて変更可能
    static_configs:
      - targets:
        - http://your_server_ip # 監視したいサーバーのIPやドメインを追加
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox_exporter:9115 # `blackbox_exporter`のアドレスとポート
```

2. **Prometheusを再起動します。**

```bash
sudo systemctl restart prometheus
```

## 4. アラートの設定

死活監視のためのアラートルールを追加する場合、Prometheusの設定ファイルやAlertmanagerの設定ファイルを適切に設定してください。

## まとめ

`blackbox_exporter`とPrometheusを組み合わせることで、サーバーの死活監視を行うことができます。更なる詳細や高度な設定については、公式ドキュメントを参照してください。

# V. サーバーのハードウェア・システムリソース監視: Prometheus

Prometheusを使用してサーバーのハードウェア状況とシステムリソースの使用状況を監視するための手順を以下に示します。

## 前提条件

- Prometheusが既にインストールされ、動作していること

## 1. `node_exporter`のインストール

`node_exporter`は、サーバーのハードウェアおよびオペレーティングシステムのメトリクスを収集するためのエクスポーターです。

1. **`node_exporter`をダウンロードします。**

```bash
cd /tmp
wget https://github.com/prometheus/node_exporter/releases/download/vX.X.X/node_exporter-X.X.X.linux-amd64.tar.gz
```

`X.X.X`はダウンロードしたいバージョンに置き換えてください。

2. **アーカイブを解凍し、バイナリを適切なディレクトリに移動します。**

```bash
tar xvzf node_exporter-X.X.X.linux-amd64.tar.gz
sudo mv node_exporter-X.X.X.linux-amd64/node_exporter /usr/local/bin/
```

3. **`node_exporter`をサービスとして実行します。**

Systemdサービスファイルを作成します。

```bash
sudo vim /etc/systemd/system/node_exporter.service
```

以下の内容を追加します。

```
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=nobody
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
```

サービスをリロードし、`node_exporter`を起動します。

```bash
sudo systemctl daemon-reload
sudo systemctl start node_exporter
sudo systemctl enable node_exporter
```

## 2. Prometheusに`node_exporter`を追加

1. **Prometheusの設定ファイルを編集します。**

```bash
sudo vim /etc/prometheus/prometheus.yml
```

以下の内容を追加します。

```yaml
scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['localhost:9100']
```

2. **Prometheusを再起動します。**

```bash
sudo systemctl restart prometheus
```

## 3. 監視対象のメトリクス

`node_exporter`は多数のメトリクスを提供します。以下は一部の重要なものを示します：

- **CPU:** `node_cpu_seconds_total`
- **Memory:** `node_memory_MemTotal_bytes`, `node_memory_MemFree_bytes`, `node_memory_MemAvailable_bytes`など
- **Disk:** `node_disk_io_time_seconds_total`, `node_disk_read_bytes_total`, `node_disk_written_bytes_total`など
- **Network:** `node_network_receive_bytes_total`, `node_network_transmit_bytes_total`など

## 4. グラフとアラート

PrometheusのWeb UIやGrafanaを使用してこれらのメトリクスを視覚化できます。また、Alertmanagerと統合することで、特定のしきい値を超えたときにアラートを受け取ることもできます。

## まとめ

`node_exporter`とPrometheusを組み合わせることで、サーバーのハードウェア状況とシステムリソースの使用状況を効果的に監視することができます。この情報は、サーバーの健康状態を確認し、適切な対応を行うために非常に役立ちます。

# VI. サーバーログ監視: Prometheus

Prometheusは主にメトリクス監視に特化していますが、ロギングの情報をメトリクス化して監視することも可能です。特に、ログの特定のイベントの頻度やパターンを追跡したい場合に役立ちます。

以下は、Prometheusを使ってサーバーログ（SSHアクセスログ、Apache Httpdログ、システムエラーログ）を監視するための基本的なマニュアルです。

## 前提条件

- Prometheusが既にインストールされ、動作していること

## 1. `mtail`のインストール

`mtail`は、ログファイルからメトリクスを抽出してPrometheus形式で公開するツールです。

1. **`mtail`をダウンロードしてインストールします。**

公式のリリースページから最新のバージョンをダウンロードします。

```bash
wget https://github.com/google/mtail/releases/download/vX.X.X/mtail_vX.X.X_linux_amd64.rpm
sudo rpm -ivh mtail_vX.X.X_linux_amd64.rpm
```

`X.X.X`を適切なバージョンに置き換えてください。

## 2. ログファイル用の`mtail`プログラムの作成

`mtail`は、特定のログファイルのパターンを検出してメトリクスを生成するための独自のプログラムを必要とします。

1. **SSHアクセスログのための`mtail`プログラム**

例: `/etc/mtail/ssh_access.mtail`

```
counter ssh_login_attempts by user, ip
/Failed password for (?P<user>\S+) from (?P<ip>\S+)/ {
  ssh_login_attempts[$user][$ip]++
}
```

2. **Apache Httpdログのための`mtail`プログラム**

例: `/etc/mtail/apache.mtail`

```
counter http_requests_total by status_code
/(?P<status_code>\d{3}) \d+/ {
  http_requests_total[$status_code]++
}
```

3. **システムエラーログのための`mtail`プログラム**

例: `/etc/mtail/system_error.mtail`

```
counter system_errors
/ERROR/ {
  system_errors++
}
```

## 3. `mtail`の実行

```bash
mtail --progs /etc/mtail/ --logs /var/log/secure,/var/log/httpd/access_log,/var/log/messages
```

このコマンドは、`/etc/mtail/`ディレクトリ内の全ての`mtail`プログラムを読み込み、指定されたログファイルを監視します。

## 4. Prometheusに`mtail`のジョブを追加

Prometheusの設定ファイルにジョブを追加します。

```bash
sudo vim /etc/prometheus/prometheus.yml
```

以下の内容を追加します。

```yaml
scrape_configs:
  - job_name: 'mtail'
    static_configs:
      - targets: ['localhost:3903']
```

Prometheusを再起動します。

```bash
sudo systemctl restart prometheus
```

## 5. メトリクスの確認とアラート

PrometheusのWeb UIで、新しいメトリクス（`ssh_login_attempts`、`http_requests_total`、`system_errors`など）を確認します。必要に応じて、Alertmanagerを使用してアラートのルールを設定できます。

## まとめ

Prometheusと`mtail`を使用して、さまざまなサーバーログを監視することができます。このマニュアルは基本的な例を示していますが、実際の運用環境に合わせてカスタマイズすることができます。

# VII. サーバープロセス監視: Prometheus

Prometheusと`node_exporter`を使用して、サーバー上の特定のプロセスのステータスを監視する方法についてのマニュアルです。

## 前提条件

- Prometheusが既にインストールされ、動作していること。
- `node_exporter`がインストールされ、動作していること。

## 1. `node_exporter`の設定

1. **`node_exporter`の設定変更**

`node_exporter`を再起動し、`--collector.processes`フラグを追加してプロセスの収集を有効にします。

```bash
sudo systemctl edit --full node_exporter
```

以下のように`ExecStart`行にフラグを追加します。

```
ExecStart=/usr/local/bin/node_exporter --collector.processes
```

2. **`node_exporter`を再起動します。**

```bash
sudo systemctl restart node_exporter
```

## 2. Prometheusの設定

1. **Prometheusのジョブ設定を確認**

既存の`node_exporter`のジョブ設定が`prometheus.yml`に存在することを確認します。もし存在しない場合、以下の設定を追加してください。

```yaml
scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['localhost:9100']
```

## 3. メトリクスの確認とアラート設定

Prometheus Web UIにアクセスして、`node_exporter`から収集されたプロセス関連のメトリクスを確認します。

以下のようなPromQLクエリを使用して、各サービスのプロセス数を取得できます。

```promql
count(node_processes_state{process_name="apache2"}) # apache httpd
count(node_processes_state{process_name="postgres"}) # postgresql
count(node_processes_state{process_name="smbd"}) # samba
count(node_processes_state{process_name="vsftpd"}) # vsftpd
count(node_processes_state{process_name="postfix"}) # postfix
```

### アラート設定

特定のサービスがダウンしている場合や、予期しないプロセス数が検出された場合にアラートを受け取るように設定することができます。以下は、Apache httpdのプロセスが存在しない場合にアラートを発生させる例です。

`prometheus.yml`に以下の内容を追加します。

```yaml
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - localhost:9093 # Alertmanagerのアドレス

rule_files:
  - "alert_rules.yml"
```

そして、`alert_rules.yml`を作成し、以下の内容を追加します。

```yaml
groups:
- name: ProcessMonitoring
  rules:
  - alert: ApacheDown
    expr: count(node_processes_state{process_name="apache2"}) == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Apache httpd process is down"
      description: "The Apache httpd process is not running on the server."
```

Prometheusを再起動して、新しいアラート設定を反映させます。

```bash
sudo systemctl restart prometheus
```

## まとめ

このマニュアルでは、Prometheusと`node_exporter`を使用してサーバー上の特定のプロセスのステータスを監視する方法を説明しました。アラート設定を使用して、サービスの問題を迅速に検出して対応することができます。

# VIII. Prometheus: よく発生する問題と解決方法

Prometheusは非常に信頼性の高い監視ツールですが、時折問題や課題に直面することがあります。以下は、Prometheusの一般的な問題とそれらの問題を解決するための推奨されるアプローチをリストアップしたマニュアルです。

## 1. ディスクスペースの問題

### 問題

Prometheusのデータストレージがディスクを埋め尽くしてしまうことがあります。

### 解決方法

- **旧いデータの削除**: Prometheusの`--storage.tsdb.retention`フラグを設定して、保持するデータの期間を制限します。
- **ストレージの拡張**: サーバのディスク容量を増やすことを検討します。
- **シャーディング**: Prometheusのシャーディングを使用して、メトリクスの収集を複数のPrometheusインスタンスに分散します。

## 2. 高いメモリ使用率

### 問題

Prometheusが大量のメモリを消費する場合があります。

### 解決方法

- **クエリの最適化**: 複雑なクエリや大量のデータを取得するクエリは、メモリ使用率を増加させる可能性があります。クエリを最適化するか、不要なクエリを削除します。
- **メトリクスの削減**: すべてのメトリクスを収集する必要はありません。`relabel_configs`を使用して、収集するメトリクスを絞り込むことができます。

## 3. ターゲットのスクレイプに失敗

### 問題

Prometheusがターゲットをスクレイプできない場合があります。

### 解決方法

- **ネットワークの確認**: ターゲットがネットワーク上でアクセス可能か確認します。
- **証明書の問題**: SSL/TLSを使用している場合、正しい証明書とキーが設定されているか確認します。
- **ターゲットのステータス確認**: 対象のエクスポーターが正しく動作しているか確認します。

## 4. 遅いクエリ応答

### 問題

Prometheusのクエリが遅い、またはタイムアウトすることがあります。

### 解決方法

- **クエリの最適化**: クエリの範囲を狭める、不要なラベルを削除するなど、クエリを最適化します。
- **サーバリソースの拡張**: サーバのCPUやメモリを増やして、リソースを拡張します。

## 5. クエリの誤った結果

### 問題

期待するクエリ結果と異なる結果が返されることがあります。

### 解決方法

- **メトリクスラベルの確認**: クエリで使用しているラベルが正しいか確認します。
- **時間範囲の確認**: クエリの時間範囲が正しいか確認します。

## 6. Prometheusのアップグレードの問題

### 問題

Prometheusをアップグレードした後、問題が発生することがあります。

### 解決方法

- **バックアップの確認**: アップグレード前にデータと設定のバックアップを取得していることを確認します。
- **互換性の確認**: アップグレード前にリリースノートやドキュメントを確認し、互換性の問題や変更点を確認します。
- **ロールバック**: 問題が解決しない場合、前のバージョンに戻すことを検討します。

## まとめ

Prometheusは非常に強力な監視ツールですが、運用中にいくつかの一般的な問題に直面する可能性があります。このマニュアルでは、一般的な問題とそれらの問題を解決するためのアプローチを提供しています。適切なトラブルシューティングと解決策の適用により、Prometheusの運用をスムーズに行うことができます。